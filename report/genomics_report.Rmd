---
title: "Genomics_report_v1"
author: "Huethercode"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: journal
---

```{r setup_load_pkg, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("karyoploteR")

#.libPaths("/home/linuxbrew/.linuxbrew/Cellar/gcc/14.2.0_1/lib/gcc/current/")
#Sys.setenv(PATH="/home/linuxbrew/.linuxbrew/Cellar/gcc/14.2.0_1/lib/gcc/current/")
#Sys.setenv("R_LIBS_USER"="/home/linuxbrew/.linuxbrew/Cellar/gcc/14.2.0_1/lib/gcc/current/")
#Sys.setenv("LD_LIBRARY_PATH"="/home/linuxbrew/.linuxbrew/Cellar/gcc/14.2.0_1/lib/gcc/current/")
library(vcfR)
library(ggplot2)
library(dplyr)
library(karyoploteR)
library(GenomicRanges)
```
# 1. Introduction and Data Import

This report provides a quality control (QC) analysis of the input Variant Call Format (VCF) file, summarizing key statistics and visualizations.

## 2. Data Import, Preprocessing, QC
```{r}

# Load a VCF file (replace 'example.vcf' with your file path)
vcf_file <- "~/Documents/genomics/exome_bk/bobby_exome_genotyped.ann.vcf"
vcf <- read.vcfR(vcf_file, verbose = FALSE)

# Filter out low-quality variants
quality_threshold <- 30
vcf <- vcf[as.numeric(vcf@fix[, "QUAL"]) >= quality_threshold, ]


# Extract genotype data
gt <- extract.gt(vcf, element = "GT", as.numeric = TRUE)

# Extract depth (DP) and genotype quality (GQ)
dp <- extract.gt(vcf, element = "DP", as.numeric = TRUE)
gq <- extract.gt(vcf, element = "GQ", as.numeric = TRUE)

# Convert to data frame for visualization
df <- data.frame(
  Sample = rep(colnames(dp), each = nrow(dp)),
  DP = as.vector(dp),
  GQ = as.vector(gq)
)

df <- df %>% filter(!is.na(DP) & !is.na(GQ))

```

## 3. Variant Quality Control Metrics

```{r qc_summary, echo=FALSE}
# Calculate Ts/Tv ratio manually
transitions <- c("A>G", "G>A", "C>T", "T>C")
transversions <- c("A>C", "A>T", "G>C", "G>T", "C>A", "C>G", "T>A", "T>G")

variants <- data.frame(
  REF = vcf@fix[, "REF"],
  ALT = vcf@fix[, "ALT"]
)

variants$Mutation <- paste(variants$REF, variants$ALT, sep = ">")

num_ts <- sum(variants$Mutation %in% transitions, na.rm = TRUE)
num_tv <- sum(variants$Mutation %in% transversions, na.rm = TRUE)
ts_tv_ratio <- num_ts / num_tv

#cat("Ts/Tv ratio:", ts_tv_ratio, "\n")

# Count SNPs and Indels based on REF and ALT fields
snp_count <- sum(nchar(variants$REF) == 1 & nchar(variants$ALT) == 1, na.rm = TRUE)
indel_count <- sum(nchar(variants$REF) > 1 | nchar(variants$ALT) > 1, na.rm = TRUE)

#cat("Number of SNPs:", snp_count, "\n")
#cat("Number of Indels:", indel_count, "\n")

# Count number of genes with a variant present
gene_info <- vcf@fix[, "INFO"]
genes <- unique(unlist(strsplit(gene_info[grep("GENE=", gene_info)], split = "GENE="))[-1])
gene_count <- length(genes)

cat("Number of Genes with Variants:", gene_count, "\n")

# Calculate QC metrics
mean_depth <- mean(dp, na.rm = TRUE)
mean_gq <- mean(gq, na.rm = TRUE)
missing_data <- mean(is.na(gt)) * 100


# Define pass/fail criteria
ts_tv_status <- ifelse(ts_tv_ratio > 2.0, "PASS", "FAIL")
depth_status <- ifelse(mean_depth > 30, "PASS", "FAIL")
gq_status <- ifelse(mean_gq > 20, "PASS", "FAIL")

# Create QC summary table
qc_summary <- data.frame(
  Metric = c("Ts/Tv Ratio", "Mean Depth (DP)", "Mean Genotype Quality (GQ)", "Number of SNPs", "Number of Indels", "Number of Genes with Variants"),
  Value = c(ts_tv_ratio, mean_depth, mean_gq, snp_count, indel_count, gene_count),
  Threshold = c("> 2.0", "> 30", "> 20", "N/A", "N/A", "N/A"),
  Status = c(ts_tv_status, depth_status, gq_status, "Info", "Info", "Info")
)
print(qc_summary)

```



Metric	Value (Observed)	Threshold	Status
Ts/Tv Ratio	ts_tv_ratio	> 2.0 (exome), > 1.8 (genome)	PASS/FAIL
Mean Depth (DP)	mean(dp, na.rm = TRUE)	> 30 (exome), > 10 (genome)	PASS/FAIL
Genotype Quality (GQ)	mean(gq, na.rm = TRUE)	> 20	PASS/FAIL
SNP Count	snp_count	N/A (context-dependent)	Info
Indel Count	indel_count	N/A (context-dependent)	Info


## 4. Depth and Variant Density Across the Genome
```{r vcf-qc-plots_density}

# Plot Depth Across the Genome on a Karyoplot as a Line Plot
kp <- plotKaryotype(genome = "hg19")# Normalize depth values between 0 and 1
depth_df <- data.frame(
  Chr = vcf@fix[, "CHROM"], 
  Position = as.numeric(vcf@fix[, "POS"]), 
  DP = rowMeans(dp, na.rm = TRUE)
)
depth_df$DP <- (depth_df$DP - min(depth_df$DP, na.rm = TRUE)) / (max(depth_df$DP, na.rm = TRUE) - min(depth_df$DP, na.rm = TRUE))
depth_df$Chr<-paste("chr", depth_df$Chr, sep="")

# Variant density data
variant_density <- data.frame(Chr = vcf@fix[, "CHROM"], Position = as.numeric(vcf@fix[, "POS"]))

# Plot Depth Across the Genome on a Karyoplot as a Line Plot
kp <- plotKaryotype(genome = "hg19")

kpDataBackground(kp, data.panel = 1, r0=0, r1=0.8)
  kpAxis(kp, ymin=0.2, ymax=1, r0=0.05, r1=0.75, col="gray50", cex=0.2)
#  kpPoints(kp, chr = depth_df$Chr, x = depth_df$Position, y = depth_df$DP, ymin=0, ymax=1, r0=0.05, r1=0.75, col="black", pch=".", cex=2)
  
#kpLines(kp, chr = depth_df$Chr, x = depth_df$Position, y = depth_df$DP, col = "blue", lwd = 2)
#kpPlotDensity(kp, data = GRanges(seqnames = variant_density$Chr, ranges = IRanges(start = variant_density$Position, width = 1)), col = "red", border = "red")
kpLines(kp, chr = depth_df$Chr, x = depth_df$Position, y = depth_df$DP, ymin=0.2, ymax=1, r0=0.05, r1=0.75, col = "blue", lwd = 2)


#kpPlotDensity(kp, data = GRanges(seqnames = variant_density$Chr, ranges = IRanges(start = variant_density$Position, width = 1)), col = "red", border = "red")

```
## 5. Allele Frequency Distribution
```{r vcf-qc-plots_af, message=FALSE, warning=FALSE}
# Extract allele frequency (AF) values from the INFO field
allele_freqs <- as.numeric(sapply(strsplit(vcf@fix[, "INFO"], ";"), function(x) {
  af_entry <- grep("AF=", x, value = TRUE)
  if (length(af_entry) > 0) {
    as.numeric(sub("AF=", "", af_entry))
  } else {
    NA
  }
}))

allele_freqs <- allele_freqs[!is.na(allele_freqs)]

# Plot allele frequency distribution
ggplot(data.frame(AF = allele_freqs), aes(x = AF)) +
  geom_histogram(binwidth = 0.05, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Allele Frequency Distribution", x = "Allele Frequency", y = "Count") +
  theme_minimal()
```


# 2. Ancestry

# 3. PGx

# 4. Hereditary Genetics

# 5. Wellness

# 6. PRS categories

